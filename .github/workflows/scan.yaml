name: GitScan

on:
    workflow_dispatch:
    schedule:
        - cron: "0 0 * * 0" # see https://crontab.guru

# allow only one concurrent scan action
concurrency:
    cancel-in-progress: true
    group: scans

jobs:
    init:
        runs-on: ubuntu-latest
        name: Prepare
        outputs:
            sites: ${{ steps.init.outputs.sites }}
        steps:
            - uses: actions/checkout@v4
            - id: init
              uses: "./.github/actions/init"
              with:
                  count: 10
            - run: |
                  pwd
                  ls
    scans:
        runs-on: ubuntu-latest
        name: Scan
        needs: init
        continue-on-error: true
        strategy:
            fail-fast: false
            max-parallel: 3
            matrix:
                sites: ${{ fromJson(needs.init.outputs.sites) }}
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ github.ref }}

            - name: "fetch repo"
              run: |
                  pwd
                  echo "${{ matrix.sites.url }}"
                  ./fetch-repo.sh "${{ matrix.sites.url }}"

            - name: "Commit"
              run: |
                  git config --global user.email 41898282+github-actions[bot]@users.noreply.github.com
                  git config --global user.name GitHub
                  git add "./repos/${{ matrix.sites.full_name }}"
                  git commit -m "update: ${{ matrix.sites.full_name }}"
                  git pull --rebase --no-ff origin ${{ github.ref }}
                  git push
